<?php
$poi_id=$this->poi_id;
$poi_type=$this->poi_type;
$stay_list=$this->stay_list;
$eat_list=$this->eat_list;
$things_list=$this->things_list;
$related_list=$this->related_list;
$thispoi=$this->thispoi;
$poi_name=$thispoi['poi_name'];



?>
<script type="text/javascript">
loadScript(); 
</script>

<div class="main-container col2-left-layout">
<!-- Left Side Bar Starts Here -->	 
<div class="col-left sidebar">
    <div class="block block-sidebar">
    <div class="block-title">
        <strong><span><?php echo $this->leftbartitle;?></span></strong>
    </div>
    <div class="block-content">
    <ul>
    <?php 
    $leftbarcontainer=$this->menuContainer('leftbarpoi');
    $leftsidebar=$this->navigation($leftbarcontainer);
    foreach ($leftbarcontainer as $pages) {
        foreach ($pages as $uid => $page) {
            $liClass = $page->getClass();
            if ($page->getLabel() !== null && $page->isVisible(true)) {
                    if ($page->getLabel() == 'Edit Related POIs')
                        {
                            continue;
                        }
                    if ($page->getLabel() == 'Edit POI')
                        {
                            echo '<li class="'.$liClass .'"><a href ='.
                    '"'.$page->getHref().'/'.$poi_id.'">'.$page->getLabel().'</a></li>', PHP_EOL;
                    } else {
                    echo '<li class="'.$liClass .'"><a href ='.
                    '"'.$page->getHref().'">'.$page->getLabel().'</a></li>', PHP_EOL;
                    }
//                echo '<li class="'.$liClass .'">' . $leftsidebar->menu()->htmlify($page) . '</li>', PHP_EOL;
        }
    }
}
?>

</ul>
    </div>
</div>
</div>
<!-- Left Side Bar Starts Here -->	 

<div class="main">
<div class="col-main">
<div class="col-main-container">
<div class="box-info">
<div class="box-head ">
    <h2><?php echo 'Related Pois of '.$poi_name;?></h2>
</div>

<input id="thispoi_lat" name = "thispoi_lat" type="hidden" value="<?php echo $thispoi['poi_lat'];?>">
<input id="thispoi_lon" name = "thispoi_lon" type="hidden" value="<?php echo  $thispoi['poi_lon'];?>">
<input id="thispoi_id" name = "thispoi_id" type="hidden" value="<?php echo  $thispoi['poi_id'];?>">
<div class="container">

<!-- Dragable-->


<div class="col3-set">
<!-- ----------------------Col 1   -->

<div class="col-1">
<div class="box-info">
<div class="input-search-box">
<input type="text" name="staysearch" id="staysearch" value=""class="input-search">
<input id="tw-input-submit" type="submit" value="" disabled="disabled"/>
</div>
<div id="divselectablelist" class="ui-widget ui-helper-clearfix">
<ul id="staylist" class="poilist  ui-helper-reset ui-helper-clearfix">
<?php 
$i=0;
foreach ($stay_list as $stay)
{?>
    <li id=<?php echo $stay['poi_id'];?> class="ui-widget-content ui-corner-tr" 
        data-lat=<?php echo $stay['poi_lat']?> data-lon = <?php echo $stay['poi_lon']?> data-poitype=<?php echo $stay['poi_type']?>
        style="cursor:move;">
        <h4><?php echo $stay['poi_name']?></h4>
        <a href="" title="View the POI" class="ui-icon ui-icon-zoomin ">View the POI</a>
		<a id = "poilist-icon" href="" title="Push to Related POI" class="ui-icon ui-icon-arrowreturnthick-1-s">Push to Related POI</a>
	</li>
    <?php }
    
?>
</ul>
</div>
</div>
</div>
<!-- ----------------------Col 2   -->
<div class="col-2">
<div class="box-info">
<div class="input-search-box">
<input type="text" name="eatsearch" id="eatsearch" value="" class="input-search">
<input id="tw-input-submit" type="submit" value="" disabled="disabled"/>
</div>
<div id="divselectablelist" class="ui-widget ui-helper-clearfix">
<ul id="eatlist" class="poilist ui-helper-reset ui-helper-clearfix">
<?php 
$i=0;
foreach ($eat_list as $eat)
{?>
    <li id=<?php echo $eat['poi_id'];?> class="ui-widget-content ui-corner-tr" 
        data-lat=<?php echo $eat['poi_lat']?> data-lon = <?php echo $eat['poi_lon']?> data-poitype=<?php echo $eat['poi_type']?>
        style="cursor:move;">
        <h4><?php echo $eat['poi_name']?></h4>
        <a href="" title="View the POI" class="ui-icon ui-icon-zoomin ">View the POI</a>
		<a id = "poilist-icon" href="" title="Push to Related POI" class="ui-icon ui-icon-arrowreturnthick-1-s">Push to Related POI</a>
	</li>
    <?php }
    
?>
</ul>
</div>
</div>
</div>
<!-- ----------------------Col 3   -->
<div class="col-3">
<div class="box-info">
<div class="input-search-box" >
<input type="text" name="thingssearch" id="thingssearch" value="" class="input-search">
<input id="tw-input-submit" type="submit" value="" disabled="disabled"/>
</div>
<div id="divselectablelist" class="ui-widget ui-helper-clearfix">
<ul id="thingslist" class="poilist ui-helper-reset ui-helper-clearfix">
<?php 
$i=0;
foreach ($things_list as $things)
{?>
    <li id=<?php echo $things['poi_id'];?> class="ui-widget-content ui-corner-tr" 
        data-lat=<?php echo $things['poi_lat']?> data-lon = <?php echo $things['poi_lon']?> data-poitype=<?php echo $things['poi_type']?>
        style="cursor:move;">
        <h4><?php echo $things['poi_name']?></h4>
        <a href="" title="View the POI" class="ui-icon ui-icon-zoomin ">View the POI</a>
		<a id = "poilist-icon" href="" title="Push to Related POI" class="ui-icon ui-icon-arrowreturnthick-1-s">Push to Related POI</a>
	</li>
    <?php }
    
?>
</ul>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<!-- ----------------------Related    -->

</div>
<div class="main-container">
<div class="relatedpoi">

<div class="container">
<div class="col2-set">
<div class="col-1">
<div class="box-info">
<div id="map_canvas2"></div>
</div>
</div>
<div class="col-2">
<div class="box-info">
<div id="divselectablelist" class="ui-widget ui-helper-clearfix">
<ul id = "relatedlist"  class="poilist ui-helper-reset ui-helper-clearfix">
<?php 
foreach ($related_list as $related)

{?>

    <li id=<?php echo $related['poi_id'];?> class="ui-widget-content ui-corner-tr"
        data-lat=<?php echo $related['poi_lat']?> data-lon = <?php echo $related['poi_lon']?> data-poitype=<?php echo $related['poi_type']?>
        style="cursor:move;">
        <h4><?php echo $related['poi_name']?></h4>
        <a href="" title="View the POI" class="ui-icon ui-icon-zoomin">View the POI</a>
		<a id = "poilist-icon2" href="" title="Push to Related POI" class="ui-icon ui-icon-arrowreturnthick-1-n">Push to Related POI</a>
	</li>
<?php }
?>

</ul>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="tooltip" class="tooltip"></div>

<script>
  $(document).ready(function() {
		var $related = $( "#relatedlist" );
		var $stay    = $( "#staylist" );
		var $eat    = $( "#eatlist" );
		var $things    = $( "#thingslist" );
		
		var dragops = {
				connectWith: "#relatedlist",
				revert:true,
				};
		var dropops = {
				connectWith: "#staylist, #eatlist, #thingslist",
				revert:true,
				update: function(event, ui) {
					var mapid = ui.item.attr("id");
				    var lat2 = ui.item.attr("data-lat");
					var lon2 = ui.item.attr("data-lon");
					
					relateItem( ui.item );
					addMarker(lat2,lon2,'r',mapid);
					}
				};
		$( "#thingslist" ).sortable(dragops);
		$( "#eatlist" ).sortable(dragops);
		$( "#staylist" ).sortable(dragops);
	    $( "#relatedlist" ).sortable(dropops);
	    
	    $("#staysearch").keyup(function(){
	        var text = $(this).val();
	        $('#staylist li').each(function(){
	             if($(this).text().toUpperCase().indexOf(text.toUpperCase()) == -1)
	                 $(this).hide();
	             else
	                $(this).show();
	        });     
	    });
	    $("#eatsearch").keyup(function(){
	        var text = $(this).val();
	        $('#eatlist li').each(function(){
	            if($(this).text().toUpperCase().indexOf(text.toUpperCase()) == -1)
	                $(this).hide();
	             else
	                $(this).show();});     
	    });
	    $("#thingssearch").keyup(function(){
	        var text = $(this).val();
	        $('#thingslist li').each(function(){
	            if($(this).text().toUpperCase().indexOf(text.toUpperCase()) == -1)
	                $(this).hide();
	             else
	                $(this).show();});     
	    });
	    function viewItem($item) {
			    var id = $item;
			    var a = 'http://myapp/poi/view/'+id;
			    $.ajax({
			        url: a,
			        success: function(data){
			            var digops = {
	            			autoOpen: false,
	            	    	resizable : false,
	    	        		show: true,
	    	        		hide: true,
	    	        		height: 300,
	    	                width: 800,
	    	        	    };
			            var divtooltip = document.getElementById("tooltip");
			            divtooltip.innerHTML = data;
			            $( "#tooltip" ).dialog(digops );		                 
					    $("#tooltip").dialog("open");},
	      	});
		};
		// Push to related function
		var move_up_icon = "<a href='' title='take the POI back' class='ui-icon ui-icon-arrowreturnthick-1-n'>The the POI Back</a>";
		function relateItem( $item ) {
		$item.fadeOut(function() {

				$item.find( "a.ui-icon-arrowreturnthick-1-s" ).remove();
				$item.append( move_up_icon).appendTo( $related ).fadeIn(function() {});
			});
	    addRow($item,'insert');
		}

		// image recycle function
		var move_icon_down= "<a href='' title='Relat this POI' class='ui-icon ui-icon-arrowreturnthick-1-s'>Delete image</a>";
		function recycleItem( $item,$itemtype ) {
		    $item.fadeOut(function() {
		        $item.find( "a.ui-icon-arrowreturnthick-1-n" ).remove();
		        if ($itemtype=='Stay'){
		            $item.append( move_icon_down).appendTo( $stay).fadeIn(function() {});}
		        else if ($itemtype=='Eat'){
		            $item.append( move_icon_down).appendTo( $eat).fadeIn(function() {});}
		        else if ($itemtype=='Things'){
		            $item.append( move_icon_down).appendTo( $things).fadeIn(function() {});}
		    });
		    var mapid= $item.attr("id");
		    removeMarker(mapid);
		    addRow($item,'delete');
		
};
		
		$( "#staylist li, #eatlist li, #thingslist li,#relatedlist li" ).click(function(event ) {
			var $item = $( this ),
				$target = $( event.target ),
				$itemid=$( this ).attr('id'),
		        $itemtype=$( this ).attr('data-poitype');
				
			if ( $target.is( "a.ui-icon-arrowreturnthick-1-s" ) ) 
			{
			    var poi_lat = $( this ).attr("data-lat");
				var poi_lon = $( this ).attr("data-lon");
				addMarker(poi_lat,poi_lon,'r',$itemid);
			    relateItem( $item );
			} else if ( $target.is( "a.ui-icon-zoomin" ) ) {
				viewItem( $itemid );
			} else if ( $target.is( "a.ui-icon-arrowreturnthick-1-n" ) ) {
				recycleItem( $item,$itemtype );
			};

			return false;
		});
		function addRow($item,action) {
		    var poi_id = document.getElementById('thispoi_id').value;
		    var relatedid = $item.attr("id");
		    var relatedtype = $item.attr("data-poitype");
		    var lat2 = $item.attr("data-lat");
		    var lon2 = $item.attr("data-lon");
		    var lat1 = document.getElementById('thispoi_lat').value;
		    var lon1 = document.getElementById('thispoi_lon').value;

		    var poi_distance = calcdist(lat1,lon1,lat2,lon2);
		    var tobeposted = {
		    		parent_poi_id: poi_id ,
		    		related_poi_id:relatedid ,
		    		poi_type:relatedtype,
		    		poi_distance:poi_distance,
		    		action:action
		    };
		    $.ajax({
	    	  type: 'POST',
	    	  url:'http://myapp/poi/related/'+poi_id,
	    	  data: tobeposted,
		      success: function(retdata){}
			});
	};
		
});
function toRad(value){
	    return value* Math.PI / 180;
};	

function calcdist(lat1,lon1,lat2,lon2){
	var R = 6371; // Radius of the earth in km
    var dLat = toRad((lat2-lat1));  // Javascript functions in radians
    var dLon = toRad((lon2-lon1));
    callat1=toRad(lat1);
    callat2=toRad(lat2);
    
    var a = Math.sin(dLat/2) * Math.sin(dLat/2) +
        Math.cos(callat1) * Math.cos(callat2) * 
        Math.sin(dLon/2) * Math.sin(dLon/2); 
    var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
    var d = R * c; // Distance in km
    d = Math.round(d);
    return d;
};

</script>
<style>
</style>